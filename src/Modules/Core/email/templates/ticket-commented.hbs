{{> base title="Nuevo Comentario en Ticket" headerColor="#6f42c1"}}

{{#*inline "content"}}
<div style="padding: 32px 24px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 24px;">
  <div style="display: flex; align-items: center; margin-bottom: 16px;">
    <div style="width: 48px; height: 48px; background-color: #6f42c1; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 16px;">
      <span style="color: white; font-size: 24px; font-weight: bold;">ðŸ’¬</span>
    </div>
    <div>
      <h2 style="margin: 0; color: #6f42c1; font-size: 24px; font-weight: 600;">
        {{#if isCopy}}CC: {{/if}}Nuevo comentario en ticket
      </h2>
      <p style="margin: 4px 0 0 0; color: #6c757d; font-size: 14px;">
        Ticket #{{ticket.ticketNumber}} â€¢ Comentario de {{user.fullName}}
      </p>
    </div>
  </div>
</div>

<div style="background-color: white; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 24px; overflow: hidden;">
  <!-- Header del ticket -->
  <div style="background: linear-gradient(135deg, #6f42c1, #5a2d91); padding: 24px; color: white;">
    <h1 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">
      {{ticket.title}}
    </h1>
    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
      <span style="background-color: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">
        #{{ticket.ticketNumber}}
      </span>
      <span style="background-color: {{ticket.priorityColor}}; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">
        {{ticket.priority}}
      </span>
      <span style="background-color: {{ticket.statusColor}}; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">
        {{ticket.status}}
      </span>
    </div>
  </div>

  <!-- Comentario principal -->
  <div style="padding: 24px;">
    {{#if message}}
    <div style="background-color: #f8f5ff; border: 2px solid #e0cffc; border-radius: 12px; padding: 20px; margin-bottom: 24px; position: relative;">
      <!-- Header del comentario -->
      <div style="display: flex; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e0cffc;">
        <div style="width: 40px; height: 40px; background-color: #6f42c1; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
          <span style="color: white; font-size: 18px; font-weight: bold;">
            {{substring user.fullName 0 2}}
          </span>
        </div>
        <div style="flex: 1;">
          <h3 style="margin: 0 0 4px 0; color: #5a2d91; font-size: 16px; font-weight: 600;">
            {{user.fullName}}
          </h3>
          <p style="margin: 0; color: #6f42c1; font-size: 14px;">{{user.email}}</p>
        </div>
        <div style="text-align: right;">
          <span style="background-color: #6f42c1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
            NUEVO
          </span>
          <p style="margin: 4px 0 0 0; color: #6c757d; font-size: 12px;">
            {{#if message.createdAt}}
            {{formatDate message.createdAt}}
            {{else}}
            Hace unos momentos
            {{/if}}
          </p>
        </div>
      </div>

      <!-- Contenido del comentario -->
      <div style="margin-bottom: 16px;">
        {{#if message.isInternal}}
        <div style="background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 6px; padding: 8px 12px; margin-bottom: 12px;">
          <span style="color: #856404; font-size: 12px; font-weight: 600;">ðŸ”’ COMENTARIO INTERNO</span>
        </div>
        {{/if}}
        
        <div style="color: #495057; line-height: 1.6; font-size: 15px;">
          {{breaklines message.content}}
        </div>
      </div>

      <!-- Archivos adjuntos del mensaje -->
      {{#if message.attachments}}
      <div style="border-top: 1px solid #e0cffc; padding-top: 16px;">
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <span style="font-size: 16px; margin-right: 8px;">ðŸ“Ž</span>
          <strong style="color: #5a2d91; font-size: 14px;">Archivos adjuntos:</strong>
        </div>
        <div style="background-color: white; border: 1px solid #e0cffc; border-radius: 6px; padding: 12px;">
          {{#each message.attachments}}
          <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
            <span style="margin-right: 8px;">ðŸ“„</span>
            <span style="color: #6f42c1; font-weight: 500;">{{this.filename}}</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">({{this.fileSize}})</span>
          </div>
          {{/each}}
        </div>
      </div>
      {{/if}}
    </div>
    {{/if}}

    {{#if customMessage}}
    <div style="background-color: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 8px 0; color: #0056b3; font-size: 14px;">Mensaje adicional:</h4>
      <p style="margin: 0; color: #495057;">{{breaklines customMessage}}</p>
    </div>
    {{/if}}

    <!-- InformaciÃ³n del ticket -->
    <div style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e9ecef;">
      <h3 style="margin: 0 0 16px 0; color: #495057; font-size: 16px; font-weight: 600;">InformaciÃ³n del ticket:</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
          <strong style="color: #495057; font-size: 14px;">Creado por:</strong>
          <p style="margin: 4px 0 0 0; color: #007bff;">{{ticket.createdBy.fullName}}</p>
        </div>
        
        {{#if ticket.assignedTo}}
        <div>
          <strong style="color: #495057; font-size: 14px;">Asignado a:</strong>
          <p style="margin: 4px 0 0 0; color: #28a745;">{{ticket.assignedTo.fullName}}</p>
        </div>
        {{/if}}

        <div>
          <strong style="color: #495057; font-size: 14px;">Estado actual:</strong>
          <span style="background-color: {{ticket.statusColor}}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
            {{ticket.status}}
          </span>
        </div>

        <div>
          <strong style="color: #495057; font-size: 14px;">Tipo:</strong>
          <p style="margin: 4px 0 0 0; color: #6f42c1;">{{ticket.ticketType.name}}</p>
        </div>

        {{#if ticket.formattedDueDate}}
        <div>
          <strong style="color: #495057; font-size: 14px;">Fecha lÃ­mite:</strong>
          <p style="margin: 4px 0 0 0; color: #fd7e14;">{{ticket.formattedDueDate}}</p>
        </div>
        {{/if}}
      </div>
    </div>
  </div>
</div>

<!-- BotÃ³n de acciÃ³n principal -->
<div style="text-align: center; margin: 32px 0;">
  <a href="{{ticket.url}}" 
     style="display: inline-block; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; text-decoration: none; padding: 16px 32px; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3); transition: all 0.2s;">
    ðŸ’¬ Ver ConversaciÃ³n Completa
  </a>
</div>

{{#unless isCopy}}
<div style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #6f42c1;">
  <h3 style="margin: 0 0 12px 0; color: #5a2d91; font-size: 16px;">Sobre este comentario:</h3>
  <ul style="margin: 0; padding-left: 20px; color: #495057;">
    <li style="margin-bottom: 8px;">{{#if message.isInternal}}Este es un comentario interno del equipo de soporte{{else}}Este comentario es visible para todos los participantes{{/if}}</li>
    <li style="margin-bottom: 8px;">Puedes responder desde el sistema de tickets</li>
    <li style="margin-bottom: 8px;">Todas las respuestas quedan registradas en el historial</li>
    <li>RecibirÃ¡s notificaciones de nuevos comentarios automÃ¡ticamente</li>
  </ul>
</div>
{{/unless}}

<!-- Historial reciente -->
{{#if ticket.recentMessages}}
<div style="background-color: white; border-radius: 8px; border: 1px solid #e9ecef; padding: 20px; margin-top: 20px;">
  <h3 style="margin: 0 0 16px 0; color: #495057; font-size: 16px; font-weight: 600;">ðŸ“œ Actividad reciente:</h3>
  
  {{#each ticket.recentMessages}}
  <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
    <div style="width: 32px; height: 32px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
      <span style="color: #6c757d; font-size: 12px; font-weight: bold;">
        {{substring this.user.fullName 0 2}}
      </span>
    </div>
    <div style="flex: 1;">
      <p style="margin: 0; color: #495057; font-size: 14px;">
        <strong>{{this.user.fullName}}</strong> 
        {{#if this.isInternal}}agregÃ³ un comentario interno{{else}}agregÃ³ un comentario{{/if}}
      </p>
      <p style="margin: 2px 0 0 0; color: #6c757d; font-size: 12px;">
        {{formatDate this.createdAt}}
      </p>
    </div>
  </div>
  {{/each}}
  
  <div style="text-align: center; margin-top: 16px;">
    <a href="{{ticket.url}}" style="color: #6f42c1; text-decoration: none; font-size: 14px;">
      Ver historial completo â†’
    </a>
  </div>
</div>
{{/if}}
{{/inline}}

{{#*inline "footer"}}
<div style="text-align: center; color: #6c757d; font-size: 12px; margin-top: 24px;">
  <p style="margin: 0 0 8px 0;">
    {{#if isCopy}}Recibiste este correo como copia de un nuevo comentario{{else}}{{#if isMainRecipient}}Recibiste este correo porque estÃ¡s relacionado con este ticket{{else}}Recibiste este correo porque eres participante en este ticket{{/if}}{{/if}}
  </p>
  <p style="margin: 0;">
    Sistema de Tickets â€¢ Charlotte Chemical Internacional â€¢ {{systemInfo.year}}
  </p>
  {{#if systemInfo.supportEmail}}
  <p style="margin: 8px 0 0 0;">
    Â¿Necesitas ayuda? Contacta: <a href="mailto:{{systemInfo.supportEmail}}" style="color: #007bff;">{{systemInfo.supportEmail}}</a>
  </p>
  {{/if}}
</div>
{{/inline}}
